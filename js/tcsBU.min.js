"use strict",$(function(){var b=null,c=null,B=null,a=[],h=[],d=[],w=!1,t=!1,p=!1,K=12,L=.05,G=-30,F=1,D=1,E=.95,I=5,S=5,k,g,l,q,v,z,C,y,e,f,i,o,x,V,u,H,J,m;e=1,f=null,i=0,o=!1,x=[{id:'none'},{icon:'icon-circles-1',id:'circles-1'},{icon:'icon-circles-2',id:'circles-2'},{icon:'icon-lines-1',id:'lines-1'},{icon:'icon-lines-2',id:'lines-2'},{icon:'icon-lines-3',id:'lines-3'},{icon:'icon-lines-4',id:'lines-4'},{icon:'icon-lines-5',id:'lines-5'},{icon:'icon-lines-6',id:'lines-6'},{icon:'icon-lines-7',id:'lines-7'},{icon:'icon-lines-8',id:'lines-8'},{icon:'icon-cross-1',id:'cross-1'},{icon:'icon-cross-2',id:'cross-2'},{icon:'icon-cross-3',id:'cross-3'},{icon:'icon-cross-4',id:'cross-4'}];function n(r,k,o){var h='ffffff',j='none',g=w2ui.groups.find({recid:k},!0)[0],m,c,f,i,n,l,d;g!=='undefined'&&(h=w2ui.groups.records[g].color,w2ui.groups.records[g].pattern!=='none'&&(j="url(#"+h+w2ui.groups.records[g].pattern+")")),m=Number(w2ui.haplotypes.records[r].haplogroup),c=$.map(a,function(a,b){if(a.id===m)return b})[0],typeof c!=='undefined'&&(f=$.map(a[c].proportions,function(a,b){if(a.group===k)return b})[0],i=$.map(a[c].proportions,function(a,b){if(a.group===o)return b})[0],typeof i!=='undefined'?(typeof f!=='undefined'?(a[c].proportions[f].value++,a[c].proportions[f].color='#'+h,a[c].proportions[f].pattern=j,a[c].proportions[i].value--):(a[c].proportions.push({color:'#'+h,group:k,radius:a[c].radius,value:1,pattern:j}),a[c].proportions[i].value--),b&&(n='#'+a[c].name,l=b.select(n),d=l.selectAll('path').remove(),d=l.selectAll('path').data(function(a){return q(a.proportions)}),d.enter().append('path').attr('d',v).style('fill',function(a,b){return a.data.pattern==='none'?a.data.color:a.data.pattern}),p?d.style('stroke-width',e/2).style('stroke','#000000'):d.style('stroke-width','0').style('stroke','none'),d.exit().remove())):w2alert('Serious error!','ERROR'))}function r(c,b){var d,a;if(c==='none')return;switch(d=b+c,a=B.append("pattern"),a.attr("id",d).attr("patternUnits","userSpaceOnUse").attr("width",10).attr("height",10),a.append("rect").attr("width","10").attr("height","10").attr("x","0").attr("y","0").attr("fill","#"+b).attr("stroke-width","0"),c){case 'lines-1':a.append('path').attr('d','M3,0 V10 M8,0 V10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'lines-2':a.append('path').attr('d','M3,0 V10 M8,0 V10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'lines-3':a.append('path').attr('d','M0,3 H10 M0,8 H10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'lines-4':a.append('path').attr('d','M0,3 H10 M0,8 H10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'lines-5':a.append('path').attr('d','M4,-1 l10,10 M-1,4 l10,10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'lines-6':a.append('path').attr('d','M4,-1 l10,10 M-1,4 l10,10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'lines-7':a.append('path').attr('d','M4,-1 l-10,10 M2,11 l10,-10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'lines-8':a.append('path').attr('d','M4,-1 l-10,10 M2,11 l10,-10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'cross-1':a.append('path').attr('d','M3,0 V10 M8,0 V10 M0,3 H10 M0,8 H10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'cross-2':a.append('path').attr('d','M3,0 V10 M8,0 V10 M0,3 H10 M0,8 H10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'cross-3':a.append('path').attr('d','M0,0 L10,10 M10,0 L0,10').attr('stroke','#000000').attr('stroke-width',.5);break;case 'cross-4':a.append('path').attr('d','M0,0 L10,10 M10,0 L0,10').attr('stroke','#000000').attr('stroke-width',1.5);break;case 'circles-1':a.append("rect").attr({width:"10",height:"10",fill:"#"+b}),a.append("circle").attr({cx:2,cy:2,r:1,transform:"translate(0,0)",fill:"#000000"}),a.append("circle").attr({cx:2,cy:7,r:1,transform:"translate(0,0)",fill:"#000000"}),a.append("circle").attr({cx:7,cy:2,r:1,transform:"translate(0,0)",fill:"#000000"}),a.append("circle").attr({cx:7,cy:7,r:1,transform:"translate(0,0)",fill:"#000000"});break;case 'circles-2':a.append("rect").attr({width:"10",height:"10",fill:"#"+b}),a.append("circle").attr({cx:5,cy:5,r:3,transform:"translate(0,0)",fill:"#000000"});break}}function j(){k=b.selectAll('.link').remove(),k=b.selectAll('.link').data(d),k.enter().append('line').attr('class','link').attr('id',function(a){return a.name}).on('mouseover',function(){d3.select(this).style({stroke:'#FF011B','stroke-width':e*3})}).on('mouseout',function(){d3.select(this).style({stroke:'#000000','stroke-width':e})}).on('click',C).append('title').text(function(a,b){return a.changes}),k.style('stroke-width',e).style('stroke','#000000'),k.exit().remove(),g=b.selectAll('.node').remove(),g=b.selectAll('.node').data(a),g.enter().append('g').attr('class','node').attr('id',function(a){return a.name}).on('click',y).call(z).insert('circle').attr('r',function(a){return a.radius}).on('mouseover',function(){d3.select(this).style({stroke:'#FF011B','stroke-width':e*4})}).on('mouseout',function(){d3.select(this).style({stroke:'#000000','stroke-width':e*2})}).append('title').text(function(a,b){return a.name}),g.style('stroke-width',function(){return e*2}).style('stroke','#000000').style('fill','white'),g.exit().remove(),l=g.selectAll('path').remove(),l=g.selectAll('path').data(function(a,b){return q(a.proportions)}),l.enter().append('path').attr('d',v).style('fill',function(a){return a.data.pattern==='none'?a.data.color:a.data.pattern}),p?l.style('stroke-width',e/2).style('stroke','#000000'):l.style('stroke-width','0').style('stroke','none'),l.exit().remove(),c.nodes(a).links(d).start()}function X(a){return $('body').append('<input id="loadGroups" type="file" />'),$('#loadGroups').on('change',function(a){O(a)}),$('#loadGroups').on('click',function(){this.value=null}),$().w2grid({name:'groups',multiSelect:!1,show:{header:!1,toolbar:!0,footer:!0,lineNumbers:!1,toolbarSearch:!1,toolbarInput:!1,toolbarReload:!1,toolbarColumns:!1,toolbarSave:!1,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1},columns:[{field:'recid',caption:'Group',size:'50%',sortable:!1,resizable:!0,editable:{type:'text'},render:function(a){return'<div style="font-weight: bold">'+a.recid+'</div>'}},{field:'color',caption:'Color',size:'25%',sortable:!1,resizable:!0,editable:{type:'color'},render:function(a){return'<div style="background-color: #'+a.color+'">&nbsp;</div>'}},{field:'pattern',caption:'Pattern',size:'25%',sortable:!1,resizable:!0,editable:{type:'combo',items:x,filter:!1},render:function(a){return'<div>'+a.pattern+'</div>'}}],records:[{recid:'Default',color:'ffffff',pattern:'none',editable:!1}],toolbar:{items:[{type:'button',id:'add_group',caption:'Add',icon:'w2ui-icon-plus'},{type:'button',id:'del_group',caption:'Delete',icon:'w2ui-icon-cross'},{type:'button',id:'load_group',caption:'Load',icon:'icon-folder-open'},{type:'button',id:'save_group',caption:'Save',icon:'icon-file-save'}],onClick:function(a){var c,b,d;switch(a.target){case 'add_group':a.preventDefault(),c=w2ui.groups.find({recid:'New Group'},!0),c.length>0?w2alert('A group named "New Group" already exists! <p> Change its name first...'):(w2ui.groups.add({recid:'New Group',color:'ffffff',pattern:'none'}),this.refresh());break;case 'del_group':a.force=!0,b=w2ui.groups.getSelection()[0],b===0?(a.preventDefault(),w2alert('Cannot delete "default" group/color...')):w2ui.haplotypes?(d=w2ui.haplotypes.records.filter(function(a){return a.group===b}),d.length>0?(a.preventDefault(),w2alert('This group is being referenced in haplotype list!<p>Change it there, and then delete it...')):w2ui.groups.delete(!0)):w2ui.groups.delete(!0);break;case 'load_group':$('#loadGroups').click();break;case 'save_group':P();break}i===1&&($('.legend').remove(),i=0,A())}},onChange:function(a){var d,c,e;switch(a.preventDefault(),a.column){case 0:if(c=w2ui.groups.find({recid:a.value_new},!0),c.length>0)w2alert('A group named "'+a.value_new+'" already exists! <p> Change its name first...');else if(w2ui.groups.records[a.index].recid=a.value_new,c=w2ui.haplotypes.find({group:a.value_original},!0),typeof c!=='undefined'&&c.length>0)for(d=0;d<c.length;d++)w2ui.haplotypes.records[c[d]].group=a.value_new,b&&n(c[d],a.value_new,a.value_original);break;case 1:if(w2ui.groups.records[a.index].color=a.value_new,w2ui.groups.records[a.index].pattern!=='none'&&($("#"+a.value_original+w2ui.groups.records[a.index].pattern).remove(),r(w2ui.groups.records[a.index].pattern,a.value_new)),c=w2ui.haplotypes.find({group:a.recid},!0),typeof c!=='undefined'&&c.length>0)for(d=0;d<c.length;d++)w2ui.haplotypes.records[c[d]].color=a.value_new,b&&n(c[d],a.recid,a.recid);break;case 2:if(w2ui.groups.records[a.index].pattern=a.value_new,b){if(e=w2ui.groups.records[a.index].color,a.value_original!=='none'&&$("#"+e+a.value_original).remove(),a.value_new!=='none'&&r(a.value_new,e),c=w2ui.haplotypes.find({group:a.recid},!0),typeof c!=='undefined'&&c.length>0)for(d=0;d<c.length;d++)n(c[d],a.recid,a.recid)}break}i===1&&($('.legend').remove(),i=0,A()),this.refresh()}}),w2ui.groups?w2ui.groups:null}function W(a){return $('body').append('<input id="loadHaplotypes" type="file" />'),$('#loadHaplotypes').on('change',function(a){N(a)}),$().w2grid({name:'haplotypes',multiSelect:!1,show:{header:!1,toolbar:!0,footer:!0,lineNumbers:!1,toolbarSearch:!1,toolbarInput:!1,toolbarReload:!1,toolbarColumns:!1,toolbarAdd:!1,toolbarDelete:!1,toolbarEdit:!1},columns:[{field:'recid',caption:'Label',size:'55%',sortable:!0,resizable:!0},{field:'haplogroup',hidden:!0},{field:'color',hidden:!0},{field:'group',caption:'Group',size:'45%',sortable:!0,resizable:!0,editable:{type:'combo',items:['Default'],filter:!1},render:function(b){var c=parseInt(b.color,16),a;return c>8388607?a='#000000':a='#ffffff','<div style="background-color: #'+b.color+'; color: '+a+'">'+b.group+'</div>'}}],toolbar:{items:[{type:'button',id:'load_haplotypes',caption:'Load',icon:'icon-folder-open'},{type:'button',id:'save_haplotypes',caption:'Save',icon:'icon-file-save'}],onClick:function(a){switch(a.target){case 'load_haplotypes':w2ui.haplotypes.records.length===0?w2alert('No data loaded yet. Haplotype/Groups data can  <br>only be imported when a list of haplotypes has <br>already been loaded through "Load Data" button.<br>','Data not yet loaded!'):$('#loadHaplotypes').click();break;case 'save_haplotypes':Q();break}}},onChange:function(a){a.preventDefault();var b=w2ui.groups.find({recid:a.value_new},!0)[0];typeof b!=='undefined'?(w2ui.haplotypes.records[a.index].group=w2ui.groups.records[b].recid,w2ui.haplotypes.records[a.index].color=w2ui.groups.records[b].color):(w2ui.haplotypes.records[a.index].group='Default',w2ui.haplotypes.records[a.index].color='ffffff'),n(a.index,a.value_new,a.value_original)},onEditField:function(d){var c=[],b=w2ui.groups.records,a;for(a=0;a<b.length;a++)c.push(b[a].recid);this.columns[3].editable.items=c}}),w2ui.haplotypes?w2ui.haplotypes:null}function A(){var e,c,b,a,d,f;if(i===0){i=1,e=[],c=[],b=w2ui.groups.records;for(a=1;a<b.length;a++)e.push(b[a].recid),b[a].pattern!=='none'?c.push("url(#"+b[a].color+b[a].pattern+")"):c.push('#'+b[a].color);d=d3.scale.ordinal(),d.domain(e),d.range(c),f=d3.svg.legend().labelFormat('none').cellPadding(5).orientation('vertical').units('Groups').cellWidth(25).cellHeight(18).inputScale(d).cellStepping(10),d3.select('svg').append('g').attr('transform','translate(50,140)').attr('class','legend').call(f)}else i=0,$('.legend').remove()}function T(a,c,d){return $('#layout').w2layout({name:'Layout',padding:0,panels:[{type:'top',size:40,resizable:!1,style:a},{type:'left',size:260,maxSize:260,resizable:!0,title:'Data',style:a,tabs:{name:'tabs',active:'tab1',tabs:[{id:'tab1',caption:'Haplotypes'},{id:'tab2',caption:'Groups'}],onClick:function(a){switch(a.target){case 'tab1':w2ui.Layout.content('left',d);break;case 'tab2':w2ui.Layout.content('left',c);break}}}},{type:'right',size:250,resizable:!1,title:'Settings',style:a},{type:'main',size:'100%',overflow:'hidden',style:a,toolbar:{items:[{id:'btn-svgsave',type:'button',caption:'Save SVG',icon:'icon-file-svg',disabled:!0},{type:'break'},{id:'btn-zoomin',class:'zoom-btn',type:'button',caption:'Zoom In',icon:'icon-zoom-in',disabled:!0},{id:'btn-zoomout',class:'zoom-btn',type:'button',caption:'Zoom Out',icon:'icon-zoom-out',disabled:!0},{type:'break'},{id:'btn-delnode',type:'check',caption:'Delete Node',icon:'icon-delete-node',disabled:!0,checked:!1},{id:'btn-dellink',type:'check',caption:'Delete Link',icon:'icon-delete-link',disabled:!0,checked:!1},{type:'break'},{id:'btn-outline',type:'check',caption:'Outline',icon:'icon-outline',disabled:!0,checked:!1},{id:'btn-lwidth',type:'menu',caption:'Line width',icon:'icon-line-width',disabled:!0,items:[{text:'0.1 px',lwidth:"0.1"},{text:'0.2 px',lwidth:"0.2"},{text:'0.4 px',lwidth:"0.4"},{text:'0.6 px',lwidth:"0.6"},{text:'0.8 px',lwidth:"0.8"},{text:'1.0 px',lwidth:"1.0"},{text:'1.5 px',lwidth:"1.5"},{text:'2.0 px',lwidth:"2.0"}]},{id:'btn-legend',type:'check',caption:'Legend',icon:'icon-legend',disabled:!0,checked:!1}],onClick:function(a){var c=a.target;switch(c){case 'btn-dellink':a.item.checked?w=!1:w=!0;break;case 'btn-delnode':a.item.checked?t=!1:t=!0;break;case 'btn-svgsave':R();break;case 'btn-outline':a.item.checked?p=!1:p=!0,b&&j();break;case 'btn-zoomin':M(1.2);break;case 'btn-zoomout':M(.8);break;case 'btn-legend':A();break;default:c.indexOf('btn-lwidth:')!==-1&&(e=a.subItem.lwidth,b&&j())}}}},{type:'bottom',size:30,resizable:!1,style:a,content:'Start'}]}),w2ui.Layout?w2ui.Layout:null}d3.svg.legend=function(){var b=[],m,c,e,l,d,g,i,k,j,h,f;c=80,e=30,l=!1,d=d3.format(".01f"),g={x:0,y:0},i="units",k=6,j=1,h="horizontal",f=0;function a(o){var m=function(c){var b=10,a=c.target.node().getBBox();a.height+=b*2,a.width+=b*2,a.y-=b,a.x-=b,c.parentGroup.select(".mutLegendBG").attr(a)},k=d3.behavior.drag().on("drag",function(a,b){a.x+=d3.event.dx,a.y+=d3.event.dy,d3.select(this).attr("transform",function(a,b){return"translate("+[a.x,a.y]+")"})}).on("dragstart",function(){d3.event.sourceEvent.stopPropagation()}),j;function n(){var a=o.append("g").attr("class","mutLegendGroup").data([g]).attr("transform","translate("+g.x+","+g.y+")"),b=a.insert("g").attr("class","mutLegendGroupText"),c=a.insert("rect",":first-child").attr("class","mutLegendBG").attr("fill","white").attr("stroke","black").attr("stroke-width","1px");return{parentGroup:a,target:b}}function p(a,c){b[a].stop[0]+=c,b[a-1].stop[1]+=c,l()}function l(){a.target.selectAll("g.legendCells").data(b).exit().remove(),a.target.selectAll("g.legendCells").select("rect").style("fill",function(a){return a.color}),h=="vertical"?(a.target.selectAll("g.legendCells").select("text.breakLabels").style("display","block").style("text-anchor","start").attr("x",c+f).attr("y",5+e/2).text(function(a){return d(a.stop[0])+(a.stop[1].length>0?" - "+d(a.stop[1]):"")}),a.target.selectAll("g.legendCells").attr("transform",function(b,a){return"translate(0,"+a*(e+f)+")"})):(a.target.selectAll("g.legendCells").attr("transform",function(b,a){return"translate("+a*c+",0)"}),a.target.selectAll("text.breakLabels").style("text-anchor","middle").attr("x",0).attr("y",-7).style("display",function(b,a){return a===0?"none":"block"}).text(function(a){return d(a.stop[0])}))}a.initDone||(j=n(),a.target=j.target,a.parentGroup=j.parentGroup,a.parentGroup.call(k),a.initDone=!0),a.target.selectAll("g.legendCells").select("text.breakLabels").remove(),a.target.selectAll("g.legendCells").select("rect").remove(),a.target.selectAll(".legendTitle").remove(),a.target.selectAll("g.legendCells").data(b).enter().append("g").attr("class","legendCells").attr("transform",function(b,a){return"translate("+a*(c+f)+",0)"}),a.target.selectAll("g.legendCells").append("rect").attr("class","breakRect").attr("height",e).attr("width",c).style("fill",function(a){return a.color}).style("stroke",function(a){return"#000000"}),a.target.selectAll("g.legendCells").append("text").attr("class","breakLabels").style("pointer-events","none"),a.target.append("text").text(i).attr("y",-7).attr("class","legendTitle"),l(),m(a)}return a.initDone=!1,a.target,a.inputScale=function(c){var a;return arguments.length?(a=c,b=[],a.invertExtent?a.range().forEach(function(c){var d={color:c,stop:a.invertExtent(c)};b.push(d)}):a.domain().forEach(function(c){var d={color:a(c),stop:[c,""]};b.push(d)}),this):a},a.scale=function(d){var c=b[b.length-1].color,a;for(a in b)if(d<b[a].stop[1]){c=b[a].color;break}return c},a.cellWidth=function(a){return arguments.length?(c=a,this):c},a.cellHeight=function(a){return arguments.length?(e=a,this):e},a.cellPadding=function(a){return arguments.length?(f=a,this):f},a.cellExtent=function(a,c){var d=b.filter(function(b){return b.color==a})[0].stop;return arguments.length==1?d:(b.filter(function(b){return b.color==a})[0].stop=c,this)},a.cellStepping=function(a){return arguments.length?(j=a,this):j},a.units=function(a){return arguments.length?(i=a,this):i},a.orientation=function(a){return arguments.length?(h=a,this):h},a.labelFormat=function(a){return arguments.length?(d=a,a=="none"&&(d=function(a){return a}),this):d},a.place=function(a){return arguments.length?(g=a,this):a},a};function Y(j){var g=[],f=j.target,i=document.getElementById('loadGraph'),e;if(f.files.length!==1)return;e=new FileReader,a=[],h=[],d=[],e.onload=function(){var z=e.result,f=z.split('\n'),o=!1,p=!1,m=!1,n,l,y,x,r,w,q,s,t,u,j,v,d,k;j=[],v=Math.PI*Math.pow(I,2);for(d=0;d<f.length;d++){if(f[d].indexOf('node [')==3&&(o=!0),f[d].indexOf('edge [')==3&&(p=!0),f[d].indexOf(']')==3)if(o){if(o=!1,j.length>0){if(l=2,q!==''){for(k=0;k<j.length;k++)j[k]=j[k].replace(/[\W]/g,"_"),/^\d+$/.test(j[k][0])&&(j[k]='L'+j[k]),g.push({recid:j[k],haplogroup:r,group:'Default',color:'ffffff'});l=Math.sqrt(n*v/Math.PI)}a.push({name:j[0],radius:l,proportions:[{group:'Default',value:n,radius:l,color:'#ffffff',pattern:'none'}],id:r}),j=[]}}else p?(p=!1,h.push({source:t,target:u,id:j[0],changes:s})):console.log('Serious Error!');o&&(f[d][0]=='"'&&m&&(m=!1),m&&j.push(f[d].trim()),f[d].indexOf('id')==6&&(r=Number(f[d].substr(9,10).trim())),f[d].indexOf('Frequency')==9&&(n=Number(f[d].substr(30,10).trim()),n>0&&(m=!0)),f[d].indexOf('label')==6&&(q=f[d].substr(12,100).replace(/"/g,' ').trim())),p&&(f[d].indexOf('label')==6&&(q=f[d].substr(12,100).replace(/"/g,'').trim()),f[d].indexOf('Changes')==9&&(s=f[d].substr(17,100).replace(/"/g,'').replace(/\t/g,' ').trim()),f[d].indexOf('source')==6&&(t=Number(f[d].substr(13,100).trim())),f[d].indexOf('target')==6&&(u=Number(f[d].substr(13,100).trim())))}w2ui.haplotypes.records.length>0&&w2ui.haplotypes.clear(),w2ui.groups.records.length>1&&(w2ui.groups.clear(),w2ui.groups.add({recid:'Default',color:'ffffff',pattern:'none',editable:!1})),b&&(d3.select("#gview").selectAll("*").remove(),b=null,c=null),w2ui.haplotypes.add(g),$('#start').prop('disabled',!0),i.value="",U()},e.readAsText(f.files[0])}function O(e){var c=e.target,d,a;if(c.files.length!==1)return;d=document.getElementById('loadGroups'),a=new FileReader,a.onload=function(){var o=a.result,k=o.split('\n'),p,m,t,c,q,j,e,g,h,i,s,l,f;l=[],f=[{recid:'Default',color:'ffffff',pattern:'none',editable:!1}];for(c=0;c<k.length;c++)j=k[c].trim(),j!==''&&(e=j.split(";"),(e.length===2||e.length===3)&&(g=e[0].trim(),g!==''&&(p=l.indexOf(g),p==-1&&(l.push(g),h=e[1].trim(),/^#[0-9a-f]{3,6}$/i.test(h)&&(h=h.substr(1)),i='none',typeof e[2]!=='undefined'&&(m=e[2].trim(),q=x.filter(function(a,b){return a.id===m})[0],typeof q!=='undefined'&&(i=m)),f.push({recid:g,color:h,pattern:i})))));if(f.length>1){{if(w2ui.groups.clear(),w2ui.groups.add(f),w2ui.haplotypes.records.length>0){for(c=0;c<w2ui.haplotypes.records.length;c++)f=w2ui.haplotypes.records[c].group,w2ui.haplotypes.records[c].group='Default',w2ui.haplotypes.records[c].color='ffffff',n(c,'Default',f);w2ui.haplotypes.refresh()}if(b){$('pattern').remove();for(c=0;c<w2ui.groups.records.length;c++)w2ui.groups.records[c].pattern!=='none'&&r(w2ui.groups.records[c].pattern,w2ui.groups.records[c].color)}}}else w2alert('This seems not to be a formatted "Group" file!<br>(CSV text file with group names and colors   <br>separated by a ; Please hit the Help button.','No groups loaded!');d.value=""},w2ui.groups.records.length>1?w2confirm('Old list will be deleted! If some haplotypes have<br>already been associated with groups (colors) they<br>may revert to default group or become associated <br>with a different group                           <p>Load the new list?',"Replace active group's list?").yes(function(){a.readAsText(c.files[0])}):a.readAsText(c.files[0])}function N(d){var b=d.target,c,a;if(b.files.length!==1)return;c=document.getElementById('loadHaplotypes'),a=new FileReader,a.onload=function(){var o=a.result,m=o.split('\n'),k,g,d,i,b,e,f,l,h;e=[];for(b=0;b<m.length;b++)k=m[b].trim(),k!==''&&(g=k.split(";"),g.length===2&&(d=g[0].trim(),d!==''&&(d=d.replace(/[\W]/g,'_'),/^\d+$/.test(d[0])&&(d='L'+d),i=g[1].trim(),i!==""&&e.push({label:d,group:i}))));if(e.length>0){for(b=0;b<e.length;b++)f=w2ui.haplotypes.find({recid:e[b].label},!0)[0],l=w2ui.groups.find({recid:e[b].group},!0)[0],typeof f!=='undefined'&&typeof l!=='undefined'&&(h=w2ui.haplotypes.records[f].group,typeof h==='undefined'&&(h='Default'),w2ui.haplotypes.records[f].group=e[b].group,w2ui.haplotypes.records[f].color=w2ui.groups.records[l].color,n(f,e[b].group,h));j(),w2ui.haplotypes.refresh()}else w2alert('This seems not to be a formatted "Haplotype" file!<br>(CSV text file with haplotype and group names     <br>separated by a ; Please hit the Help button.','No haplotypes loaded!');c.value=""},w2ui.groups.records.length>1?w2confirm("Colors will be replaced in the haplotype list! If<br>any color has already been assigned they will be<br>overriden! Load the colors' list, anyway?       <br>","Replace active group's list?").yes(function(){a.readAsText(b.files[0])}):a.readAsText(b.files[0])}function s(b){var a,d,c;o?window.ActiveXObject?!!window.ActiveXObject&&document.execCommand&&(c=window.open('examples/'+b,'_blank'),c.document.close(),c.document.execCommand('SaveAs',!0,b||'examples/'+b),c.close()):(a=document.createElement('a'),a.href='examples/'+b,a.target='_blank',a.download=b||'unknown',d=document.createEvent('Event'),d.initEvent('click',!0,!0),a.dispatchEvent(d),(window.URL||window.webkitURL).revokeObjectURL(a.href)):w2alert('FileSaver.js is not supported! Use a modern browser...<br>FileSaver.js is supported by Firefox 20+, Chrome, Chrome<br>for Android, IE 10+, Opera 15+ and Safari 6.1+','FileSave.js is unsupported!')}function P(){var b,c,d,e,a,f;if(o){if(e=[],w2ui.groups.records.length>0){for(a=1;a<w2ui.groups.records.length;a++)b=w2ui.groups.records[a].recid,c=w2ui.groups.records[a].color,d=w2ui.groups.records[a].pattern,e.push(b+';#'+c+';'+d+'\n');f=new Blob(e,{type:"text/plain;charset=utf-8"},{endings:"native"}),saveAs(f,"groups.csv")}}else w2alert('FileSaver.js is not supported! Use a modern browser...<br>FileSaver.js is supported by Firefox 20+, Chrome, Chrome<br>for Android, IE 10+, Opera 15+ and Safari 6.1+','FileSave.js is unsupported!')}function Q(){var b,c,d,a,e;if(o){if(d=[],w2ui.haplotypes.records.length>0){for(a=0;a<w2ui.haplotypes.records.length;a++)b=w2ui.haplotypes.records[a].recid,c=w2ui.haplotypes.records[a].group,d.push(b+';'+c+'\n');e=new Blob(d,{type:"text/plain;charset=utf-8"},{endings:"native"}),saveAs(e,"haplotypes.csv")}}else w2alert('FileSaver.js is not supported! Use a modern browser...<br>FileSaver.js is supported by Firefox 20+, Chrome, Chrome<br>for Android, IE 10+, Opera 15+ and Safari 6.1+','FileSave.js is unsupported!')}function R(){var a,b;o&&(a=$('#gview'),b=new Blob([a.html()],{type:"text/plain;charset=utf-8"}),saveAs(b,"network.svg"))}function Z(){var c,a,b;try{c=!!new Blob,a=$('#gview'),b=new Blob([a.html()],{type:"text/plain;charset=utf-8"}),saveAs(b,"network.svg")}catch(a){w2alert('FileSaver.js is not supported! Use a modern browser...<br>FileSaver.js is supported by Firefox 20+, Chrome, Chrome<br>for Android, IE 10+, Opera 15+ and Safari 6.1+','File Save Failed!')}}function M(j){var d,g,a,h,i,e,c;if(!f)return;d=f.scale(),g=f.scaleExtent(),a=d*j,h=$('#gview').width(),i=$('#gview').height(),g[0]<=a&&a<=g[1]&&(e=f.translate(),c=[h/2,i/2],f.scale(a).translate([c[0]+(e[0]-c[0])/d*a,c[1]+(e[1]-c[1])/d*a]).event(b.transition().duration(350)))}function U(){var O=0,m=F,o=D,p=E,n=G,s=L,l,i,u,x;d=[],a.sort(function(a,b){var c=a.radius<b.radius?1:a.radius>b.radius?-1:0;return c});for(i=0;i<h.length;i++)l=a.filter(function(a){return a.id===h[i].source||a.id===h[i].target}),l.length==2&&d.push({source:l[0],target:l[1],id:"Link "+h[i].id,ldist:l[0].radius+l[1].radius+m+K,changes:h[i].changes});f=d3.behavior.zoom().on("zoom",H);function H(){b.attr("transform","translate("+f.translate()+")"+"scale("+f.scale()+")")}u=$('#gview').width(),x=$('#gview').height(),$('#gview').empty(),b=d3.select('#gview').append('svg').attr('id','SVG').attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+u+" "+x).attr("preserveAspectRatio","xMidYMid meet").call(f).append('g'),c=d3.layout.force().charge(function(a){return a?a.radius*n:n}).linkDistance(function(a){return a?a.ldist*m:m}).gravity(s).friction(p).linkStrength(o).chargeDistance(1/0).size([u,x]).on('end',function(){$('#stop').prop('disabled',!0),$('#start').prop('disabled',!1)}).on('start',function(){$('#stop').prop('disabled',!1),$('#start').prop('disabled',!0)}),q=d3.layout.pie().sort(null).value(function(a){return a.value}),v=d3.svg.arc().outerRadius(function(a){return a.data.radius}).innerRadius(0),B=b.append("defs");for(i=1;i<w2ui.groups.records.length;i++)w2ui.groups.records[i].pattern!=='none'&&r(w2ui.groups.records[i].pattern,w2ui.groups.records[i].color);c.on("tick",function(){k.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),g.attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}),z=c.drag().on("dragstart",function(a){d3.event.sourceEvent.stopPropagation()}),y=function(b){if(t){a.splice(a.indexOf(b),1);var c=d.filter(function(a){return a.source===b||a.target===b});c.map(function(a){d.splice(d.indexOf(a),1)}),j()}},C=function(a){w&&(d.splice(d.indexOf(a),1),j())};function I(a){c.stop(),n=a,c.start()}$('#charge').on('change',function(a){a.onComplete=I(a.target.value)});function J(a){c.stop(),m=a,c.start()}$('#linkDistance').on('change',function(a){a.onComplete=J(a.target.value)});function M(a){c.stop().linkStrength(a).start()}$('#linkStrength').on('change',function(a){a.onComplete=M(a.target.value)});function N(a){c.stop().friction(a).start()}$('#friction').on('change',function(a){a.onComplete=N(a.target.value)});function A(a){c.stop().gravity(a).start()}$('#gravity').on('change',function(a){a.onComplete=A(a.target.value)}),$('#linkDistance').attr('value',m),$('#linkStrength').attr('value',o),$('#friction').attr('value',p),$('#charge').attr('value',n),$('#gravity').attr('value',s),$('#lwidth').attr('value',e),$('#start').prop('disabled',!0).on('click',function(a){$('#start').prop('disabled',!0),$('#stop').prop('disabled',!1),j()}),$('#stop').prop('disabled',!1).on('click',function(a){$('#stop').prop('disabled',!0),$('#start').prop('disabled',!1),c.stop()}),$('#reset').prop('disabled',!1),w2ui.Layout_main_toolbar.enable('btn-dellink','btn-delnode','btn-svgsave','btn-outline','btn-lwidth','btn-zoomin','btn-zoomout','btn-legend'),j()}if(window.File&&window.FileReader&&window.FileList&&window.Blob){try{V=!!new Blob,o=!0}catch(a){w2alert('FileSaver.js is not supported! Use a modern browser...<br>FileSaver.js is supported by Firefox 20+, Chrome, Chrome<br>for Android, IE 10+, Opera 15+ and Safari 6.1+','File Save Failed!')}u='background-color: #F5F6F7; border: 1px solid silver; padding: 3px',H=X(u),J=W(u),m=T(u,H,J),m.content('top','<div style="float: left;"><button id="loadData" class="w2ui-btn">Load Data</button></div><div style="float: right;"><button id="help" class="w2ui-btn">Help</button></div>'),m.content('left',w2ui.haplotypes),m.content('right','<div style="width=100%; height=100%;"><div style="width=100%; height=100%;"><p></p><div class="w2ui-field"><label>Link Distance:</label><div><input type="text" id="linkDistance" /></div></div><div class="w2ui-field"><label>Link Strength:</label><div><input type="text" id="linkStrength"  /></div></div><div class="w2ui-field"><label>Friction:</label><div><input type="text" id="friction"  /></div></div><div class="w2ui-field"><label>Charge:</label><div><input type="text" id="charge"  /></div></div><div class="w2ui-field"><label>Gravity:</label><div><input type="text" id="gravity" /></div></div></div><div style="width=100%; height=100%;"><p><div style="text-align: center;"><button class="w2ui-btn" id="start" name="start" disabled>Start</button></div><p><div style="text-align: center;"><button class="w2ui-btn" id="stop" name="stop" disabled>Stop</button></div></div><div style="margin: 10px; padding-top: 6px; width: 90%; height: 100%; background-color: #EFF0F1;"><p style="text-align: center;">Examples</p><div style="text-align: center;"><button class="w2ui-btn" id="tcsdata" name="tcsdata">TCS network</button></div><p><div style="text-align: center;"><button class="w2ui-btn" id="groups" name="groups">Classification Groups</button></div><p><div style="text-align: center;"><button class="w2ui-btn" id="haplotypes" name="haplotypes">Classified Haplotypes</button></div><p><div style="text-align: center;"><button class="w2ui-btn" id="gpatterns" name="gpatterns">Groups with patterns</button></div><p></div></div>'),m.content('main','<div id="gview" style="width=100%; height=100%;"><div style="width=50%; padding: 20%; font-size: 160%;"><b>A paper describing tcsBU has been published in the journal <i>Bioinformatics</i> and is already available at their web site. Please cite as:</b><p>Santos, AM, Cabezas MP, Tavares AI, Xavier R, Branco M (2016) tcsBU: a tool to extend TCS network layout and visualization. <i>Bioinformatics</i>, btv636 (<a href="https://academic.oup.com/bioinformatics/article/32/4/627/1744448/" target="blank">doi: 10.1093/bioinformatics/btv636</a>)</div></div>'),m.content('bottom',''),$('body').append('<input id="loadGraph" type="file" />'),$('#loadGraph').on('change',function(a){Y(a)}),$('#loadData').click(function(){$('#loadGraph').click()}),$('#linkDistance').w2field('float',{min:.1,max:10,step:.1,arrows:!0}),$('#linkStrength').w2field('float',{min:0,max:1,step:.02,arrows:!0}),$('#friction').w2field('float',{min:0,max:1,step:.02,arrows:!0}),$('#charge').w2field('int',{min:-1e3,max:1e3,step:10,arrows:!0}),$('#gravity').w2field('float',{min:0,max:1,step:.001,arrows:!0}),$('#tcsdata').click(function(){s('tcs-output.graph.txt')}),$('#groups').click(function(){s('groups.txt')}),$('#haplotypes').click(function(){s('haplotypes.txt')}),$("#gpatterns").click(function(){s("groups-patterns.txt")}),$('#help').click(function(){$().w2popup({url:'docs/help.html',title:'tcsBU HELP',width:800,height:500})})}else w2alert('The File APIs are not fully supported by your browser.')})